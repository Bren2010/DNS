- name: Add dnsproxy group
  become: true
  group:
    name: dnsproxy
    state: present

- name: Add dnsproxy user
  become: true
  user:
    name: dnsproxy
    group: dnsproxy
    shell: /bin/bash
    create_home: true

- name: Download dnsproxy
  get_url:
    url: https://github.com/AdguardTeam/dnsproxy/releases/download/v0.36.0/dnsproxy-linux-amd64-v0.36.0.tar.gz
    dest: /home/dnsproxy/dnsproxy.tgz

- name: Unpack dnsproxy
  unarchive:
    src: /home/dnsproxy/dnsproxy.tgz
    dest: /home/dnsproxy/dnsproxy

- name: Copy dnsproxy default
  become: true
  template:
    src: dnsproxy
    dest: /etc/default/dnsproxy
  register: dnsproxy_default

- name: Copy dnsproxy service
  become: true
  template:
    src: dnsproxy.service
    dest: /lib/systemd/system/dnsproxy.service
  register: dnsproxy_service

- name: Restart service
  become: true
  systemd:
    service: dnsproxy
    daemon_reload: true
    state: restarted
  when: dnsproxy_service.changed or dnsproxy_default.changed
